<html>

<head>
<style type="text/css">
.inline {
  background-color: #f7f7f7;
  border:solid 1px #B0B0B0;
}
.error {
	font-weight: bold;
	color: #FF0000;
}
.warning {
	font-weight: bold;
}
.message {
	font-style: italic;
}
.source, .output, .warning, .error, .message {
	padding: 0 1em;
  border:solid 1px #F7F7F7;
}
.source {
  background-color: #f5f5f5;
}
.left {
  text-align: left;
}
.right {
  text-align: right;
}
.center {
  text-align: center;
}
.hl.num {
  color: #AF0F91;
}
.hl.str {
  color: #317ECC;
}
.hl.com {
  color: #AD95AF;
  font-style: italic;
}
.hl.opt {
  color: #000000;
}
.hl.std {
  color: #585858;
}
.hl.kwa {
  color: #295F94;
  font-weight: bold;
}
.hl.kwb {
  color: #B05A65;
}
.hl.kwc {
  color: #55aa55;
}
.hl.kwd {
  color: #BC5A65;
  font-weight: bold;
}
</style>
<title>Looking at the online black market in World of Warcraft</title>
</head>

<h1>
World of Warcraft and the online black market, part 3.
</h1>

<body>
This last and final look at the online gold market for world of warcraft looks at the token prices and tries to forecast the price based on just historical values.


<div class="chunk" id="unnamed-chunk-1"><div class="rcode"><div class="source"><pre class="knitr r"><span class="hl com">## supressing package warnings</span>
<span class="hl kwd">options</span><span class="hl std">(</span><span class="hl kwc">warn</span><span class="hl std">=</span><span class="hl opt">-</span><span class="hl num">1</span><span class="hl std">)</span>
<span class="hl com">## loading the packages you want</span>
<span class="hl kwd">library</span><span class="hl std">(tidyverse,</span> <span class="hl kwc">quietly</span> <span class="hl std">=</span> <span class="hl num">TRUE</span><span class="hl std">)</span>
<span class="hl kwd">library</span><span class="hl std">(forecastHybrid,</span> <span class="hl kwc">quietly</span> <span class="hl std">=</span> <span class="hl num">TRUE</span><span class="hl std">)</span>
<span class="hl kwd">library</span><span class="hl std">(Metrics,</span> <span class="hl kwc">quietly</span> <span class="hl std">=</span> <span class="hl num">TRUE</span><span class="hl std">)</span>
<span class="hl kwd">library</span><span class="hl std">(dplyr,</span> <span class="hl kwc">quietly</span> <span class="hl std">=</span> <span class="hl num">TRUE</span><span class="hl std">)</span>
<span class="hl kwd">library</span><span class="hl std">(prophet,</span> <span class="hl kwc">quietly</span> <span class="hl std">=</span> <span class="hl num">TRUE</span><span class="hl std">)</span>


<span class="hl com">## renaming the files and removing the singular date value at the end of the file</span>
<span class="hl std">token</span> <span class="hl kwb">&lt;-</span> <span class="hl std">wowtokenstata</span>
<span class="hl std">token</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">na.omit</span><span class="hl std">(token)</span>

<span class="hl com">## subsetting on regions</span>
<span class="hl std">token_cn</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">subset</span><span class="hl std">(token, region</span><span class="hl opt">==</span><span class="hl str">&quot;CN&quot;</span><span class="hl std">)</span>
<span class="hl std">token_eu</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">subset</span><span class="hl std">(token, region</span><span class="hl opt">==</span><span class="hl str">&quot;EU&quot;</span><span class="hl std">)</span>
<span class="hl std">token_kr</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">subset</span><span class="hl std">(token, region</span><span class="hl opt">==</span><span class="hl str">&quot;KR&quot;</span><span class="hl std">)</span>
<span class="hl std">token_nam</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">subset</span><span class="hl std">(token, region</span><span class="hl opt">==</span><span class="hl str">&quot;NAM&quot;</span><span class="hl std">)</span>
<span class="hl std">token_tw</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">subset</span><span class="hl std">(token, region</span><span class="hl opt">==</span><span class="hl str">&quot;TW&quot;</span><span class="hl std">)</span>
</pre></div>
</div></div>

<p>Next we are essentially making our main function that'll do everything for us when we call it,</p>

<div class="chunk" id="unnamed-chunk-2"><div class="rcode"><div class="source"><pre class="knitr r"><span class="hl com">## turning what we did in the last paper into a function so I can apply it to all the seperate data sets.</span>
<span class="hl std">forecast_token</span> <span class="hl kwb">&lt;-</span> <span class="hl kwa">function</span><span class="hl std">(</span><span class="hl kwc">data</span><span class="hl std">,</span> <span class="hl kwc">ahead</span> <span class="hl std">){</span>
  <span class="hl std">arimaGold</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">auto.arima</span><span class="hl std">(data</span><span class="hl opt">$</span><span class="hl std">gtousd)</span>
  <span class="hl std">fcastarimagold</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">forecast</span><span class="hl std">(arimaGold,</span> <span class="hl kwc">h</span><span class="hl std">= ahead)</span>
  <span class="hl std">x</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">plot</span><span class="hl std">(fcastarimagold,</span> <span class="hl kwc">include</span> <span class="hl std">=</span> <span class="hl num">50</span><span class="hl std">)</span>

  <span class="hl std">etsGold</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">ets</span><span class="hl std">(data</span><span class="hl opt">$</span><span class="hl std">gtousd)</span>
  <span class="hl std">fcastetsgold</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">forecast</span><span class="hl std">(etsGold,</span> <span class="hl kwc">h</span><span class="hl std">=ahead)</span>
  <span class="hl std">x1</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">plot</span><span class="hl std">(fcastetsgold,</span> <span class="hl kwc">include</span> <span class="hl std">=</span> <span class="hl num">50</span><span class="hl std">)</span>

  <span class="hl std">tbatsGold</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">tbats</span><span class="hl std">(data</span><span class="hl opt">$</span><span class="hl std">gtousd)</span>
  <span class="hl std">fcasttbatsgold</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">forecast</span><span class="hl std">(tbatsGold,</span> <span class="hl kwc">h</span><span class="hl std">=ahead)</span>
  <span class="hl std">x2</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">plot</span><span class="hl std">(fcasttbatsgold,</span> <span class="hl kwc">include</span> <span class="hl std">=</span> <span class="hl num">50</span><span class="hl std">)</span>

  <span class="hl std">prophetBlack</span> <span class="hl kwb">&lt;-</span> <span class="hl std">data</span>
  <span class="hl std">prophetBlack</span> <span class="hl kwb">&lt;-</span> <span class="hl std">prophetBlack[</span><span class="hl kwd">c</span><span class="hl std">(</span><span class="hl num">2</span><span class="hl std">,</span><span class="hl num">4</span><span class="hl std">)]</span>
  <span class="hl std">prophetBlack</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">rename</span><span class="hl std">(prophetBlack,</span> <span class="hl kwc">ds</span> <span class="hl std">= date,</span> <span class="hl kwc">y</span> <span class="hl std">= gtousd)</span>

  <span class="hl std">pBlack</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">prophet</span><span class="hl std">(prophetBlack)</span>
  <span class="hl std">fprophet</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">make_future_dataframe</span><span class="hl std">(pBlack,</span> <span class="hl kwc">periods</span> <span class="hl std">= ahead,</span> <span class="hl kwc">freq</span> <span class="hl std">=</span> <span class="hl str">&quot;day&quot;</span><span class="hl std">)</span>
  <span class="hl std">fcastprophet</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">predict</span><span class="hl std">(pBlack, fprophet)</span>
  <span class="hl std">x3</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">plot</span><span class="hl std">(pBlack, fcastprophet)</span>

  <span class="hl std">hybridblack</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">hybridModel</span><span class="hl std">(data</span><span class="hl opt">$</span><span class="hl std">gtousd,</span> <span class="hl kwc">weights</span> <span class="hl std">=</span> <span class="hl str">&quot;insample.errors&quot;</span><span class="hl std">,</span> <span class="hl kwc">errorMethod</span> <span class="hl std">=</span> <span class="hl str">&quot;MASE&quot;</span><span class="hl std">)</span>
  <span class="hl std">blackfcast</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">forecast</span><span class="hl std">(hybridblack,</span> <span class="hl kwc">h</span><span class="hl std">=ahead)</span>
  <span class="hl std">x4</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">plot</span><span class="hl std">(blackfcast,</span> <span class="hl kwc">include</span> <span class="hl std">=</span> <span class="hl num">50</span><span class="hl std">)</span>

  <span class="hl std">hybridblack1</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">hybridModel</span><span class="hl std">(data</span><span class="hl opt">$</span><span class="hl std">gtousd,</span> <span class="hl kwc">weights</span> <span class="hl std">=</span> <span class="hl str">&quot;equal&quot;</span><span class="hl std">,</span> <span class="hl kwc">errorMethod</span> <span class="hl std">=</span> <span class="hl str">&quot;MASE&quot;</span><span class="hl std">)</span>
  <span class="hl std">blackfcast1</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">forecast</span><span class="hl std">(hybridblack1,</span> <span class="hl kwc">h</span><span class="hl std">=ahead)</span>
  <span class="hl std">x5</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">plot</span><span class="hl std">(blackfcast1,</span> <span class="hl kwc">include</span> <span class="hl std">=</span> <span class="hl num">50</span><span class="hl std">)</span>

  <span class="hl std">actVsFcast</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">cbind</span><span class="hl std">(</span><span class="hl kwd">ts</span><span class="hl std">(data</span><span class="hl opt">$</span><span class="hl std">gtousd),</span> <span class="hl kwd">ts</span><span class="hl std">(fcastetsgold</span><span class="hl opt">$</span><span class="hl std">mean,</span> <span class="hl kwc">start</span> <span class="hl std">=</span> <span class="hl kwd">length</span><span class="hl std">(data)</span><span class="hl opt">-</span><span class="hl kwd">length</span><span class="hl std">(ahead)),</span> <span class="hl kwd">ts</span><span class="hl std">(fcastarimagold</span><span class="hl opt">$</span><span class="hl std">mean,</span> <span class="hl kwc">start</span> <span class="hl std">=</span>   <span class="hl kwd">length</span><span class="hl std">(data)</span><span class="hl opt">-</span><span class="hl kwd">length</span><span class="hl std">(ahead)),</span> <span class="hl kwd">ts</span><span class="hl std">(fcasttbatsgold</span><span class="hl opt">$</span><span class="hl std">mean,</span> <span class="hl kwc">start</span> <span class="hl std">=</span> <span class="hl kwd">length</span><span class="hl std">(data)</span><span class="hl opt">-</span><span class="hl kwd">length</span><span class="hl std">(ahead)),</span> <span class="hl kwd">ts</span><span class="hl std">(</span><span class="hl kwd">tail</span><span class="hl std">(fcastprophet</span><span class="hl opt">$</span><span class="hl std">yhat,ahead),</span>       <span class="hl kwc">start</span> <span class="hl std">=</span> <span class="hl kwd">length</span><span class="hl std">(data)</span><span class="hl opt">-</span><span class="hl kwd">length</span><span class="hl std">(ahead)),</span> <span class="hl kwd">ts</span><span class="hl std">(blackfcast</span><span class="hl opt">$</span><span class="hl std">mean,</span> <span class="hl kwc">start</span> <span class="hl std">=</span> <span class="hl kwd">length</span><span class="hl std">(data)</span><span class="hl opt">-</span><span class="hl kwd">length</span><span class="hl std">(ahead)),</span> <span class="hl kwd">ts</span><span class="hl std">(blackfcast1</span><span class="hl opt">$</span><span class="hl std">mean,</span> <span class="hl kwc">start</span> <span class="hl std">=</span>        <span class="hl kwd">length</span>   <span class="hl std">(data)</span><span class="hl opt">-</span><span class="hl kwd">length</span><span class="hl std">(ahead)))</span>
  <span class="hl kwd">colnames</span><span class="hl std">(actVsFcast)</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">c</span><span class="hl std">(</span><span class="hl str">&quot;Orignal&quot;</span><span class="hl std">,</span> <span class="hl str">&quot;ETS&quot;</span><span class="hl std">,</span> <span class="hl str">&quot;Arima&quot;</span><span class="hl std">,</span> <span class="hl str">&quot;Tbats&quot;</span><span class="hl std">,</span> <span class="hl str">&quot;Prophet&quot;</span><span class="hl std">,</span> <span class="hl str">&quot;HybridE&quot;</span><span class="hl std">,</span> <span class="hl str">&quot;HybridIn&quot;</span><span class="hl std">)</span>
  <span class="hl std">x6</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">autoplot</span><span class="hl std">(actVsFcast)</span>



  <span class="hl std">ETS</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">rbind</span><span class="hl std">(</span><span class="hl kwd">mape</span><span class="hl std">(</span><span class="hl kwd">tail</span><span class="hl std">(data</span><span class="hl opt">$</span><span class="hl std">gtousd,ahead),fcastetsgold</span><span class="hl opt">$</span><span class="hl std">mean))</span>
  <span class="hl std">ARIMA</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">rbind</span><span class="hl std">(</span><span class="hl kwd">mape</span><span class="hl std">(</span><span class="hl kwd">tail</span><span class="hl std">(data</span><span class="hl opt">$</span><span class="hl std">gtousd,ahead),fcastarimagold</span><span class="hl opt">$</span><span class="hl std">mean))</span>
  <span class="hl std">TBATS</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">rbind</span><span class="hl std">(</span><span class="hl kwd">mape</span><span class="hl std">(</span><span class="hl kwd">tail</span><span class="hl std">(data</span><span class="hl opt">$</span><span class="hl std">gtousd,ahead),fcasttbatsgold</span><span class="hl opt">$</span><span class="hl std">mean))</span>
  <span class="hl std">PROPHET</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">rbind</span><span class="hl std">(</span><span class="hl kwd">mape</span><span class="hl std">(</span><span class="hl kwd">tail</span><span class="hl std">(data</span><span class="hl opt">$</span><span class="hl std">gtousd,ahead),</span><span class="hl kwd">tail</span><span class="hl std">(fcastprophet</span><span class="hl opt">$</span><span class="hl std">yhat,ahead)))</span>
  <span class="hl std">HYBRIDE</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">rbind</span><span class="hl std">(</span><span class="hl kwd">mape</span><span class="hl std">(</span><span class="hl kwd">tail</span><span class="hl std">(data</span><span class="hl opt">$</span><span class="hl std">gtousd,ahead),blackfcast</span><span class="hl opt">$</span><span class="hl std">mean))</span>
  <span class="hl std">HYBRIDIN</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">rbind</span><span class="hl std">(</span><span class="hl kwd">mape</span><span class="hl std">(</span><span class="hl kwd">tail</span><span class="hl std">(data</span><span class="hl opt">$</span><span class="hl std">gtousd,ahead),blackfcast1</span><span class="hl opt">$</span><span class="hl std">mean))</span>

  <span class="hl std">error_metrics</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">cbind</span><span class="hl std">(ETS, ARIMA, TBATS, PROPHET, HYBRIDE, HYBRIDIN)</span>
  <span class="hl kwd">colnames</span><span class="hl std">(error_metrics)</span> <span class="hl kwb">&lt;-</span><span class="hl kwd">c</span><span class="hl std">(</span><span class="hl str">&quot;ETS&quot;</span><span class="hl std">,</span> <span class="hl str">&quot;Arima&quot;</span><span class="hl std">,</span> <span class="hl str">&quot;Tbats&quot;</span><span class="hl std">,</span> <span class="hl str">&quot;Prophet&quot;</span><span class="hl std">,</span> <span class="hl str">&quot;HybridE&quot;</span><span class="hl std">,</span> <span class="hl str">&quot;HybridIn&quot;</span><span class="hl std">)</span>
  <span class="hl std">error_metrics</span>

  <span class="hl com">#most_precise &lt;- cbind(ts(data$gtousd), ts(blackfcast1$mean, start = 117)) </span>
  <span class="hl com">#colnames(most_precise) &lt;- c(&quot;Original&quot;, &quot;HybridIn&quot;)</span>
  <span class="hl com">#x7 &lt;- autoplot(most_precise)</span>

  <span class="hl kwd">return</span><span class="hl std">(error_metrics)</span>

<span class="hl std">}</span>
</pre></div>
</div></div>

<p> The last part is greened out since we don't know what the best forecast is for the tokens. If you want you can just look at the MAPE's and do an min() statement to pick the best one. I was getting bored of this data set so I neglected to do that. I will leave that as a task to the reader, if anyone ever does read this. </p>

<div class="chunk" id="unnamed-chunk-3"><div class="rcode"><div class="source"><pre class="knitr r"><span class="hl com">## calling the function</span>
<span class="hl std">cn</span> <span class="hl kwb">&lt;-</span>  <span class="hl kwd">forecast_token</span><span class="hl std">(token_cn,</span> <span class="hl num">5</span><span class="hl std">)</span>
</pre></div>
</div><div class="rimage default"><img src="figure/unnamed-chunk-3-1.png" title="plot of chunk unnamed-chunk-3" alt="plot of chunk unnamed-chunk-3" class="plot" /></div><div class="rimage default"><img src="figure/unnamed-chunk-3-2.png" title="plot of chunk unnamed-chunk-3" alt="plot of chunk unnamed-chunk-3" class="plot" /></div><div class="rimage default"><img src="figure/unnamed-chunk-3-3.png" title="plot of chunk unnamed-chunk-3" alt="plot of chunk unnamed-chunk-3" class="plot" /></div><div class="rimage default"><img src="figure/unnamed-chunk-3-4.png" title="plot of chunk unnamed-chunk-3" alt="plot of chunk unnamed-chunk-3" class="plot" /></div><div class="rimage default"><img src="figure/unnamed-chunk-3-5.png" title="plot of chunk unnamed-chunk-3" alt="plot of chunk unnamed-chunk-3" class="plot" /></div><div class="rcode">
<div class="source"><pre class="knitr r"><span class="hl com">#tw &lt;-  forecast_token(token_tw, 5)</span>
<span class="hl com">#na &lt;-  forecast_token(token_nam, 5)</span>
<span class="hl com">#kr &lt;-  forecast_token(token_kr, 5)</span>
<span class="hl com">#eu &lt;-  forecast_token(token_eu, 5)</span>

<span class="hl com">## making a final data frame with all the errors</span>
<span class="hl kwd">row.names</span><span class="hl std">(cn)</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">c</span><span class="hl std">(</span><span class="hl str">&quot;China&quot;</span><span class="hl std">)</span>
<span class="hl std">final</span> <span class="hl kwb">&lt;-</span> <span class="hl std">cn</span>
<span class="hl com">## changing the mape to make it eaiser to explain</span>
<span class="hl std">final</span> <span class="hl kwb">&lt;-</span> <span class="hl std">final</span><span class="hl opt">*</span><span class="hl num">100</span>
<span class="hl std">final</span>
</pre></div>
<div class="output"><pre class="knitr r">##            ETS     Arima     Tbats  Prophet   HybridE  HybridIn
## China 0.266724 0.3006359 0.2897247 8.474142 0.4654321 0.4832933
</pre></div>
<div class="source"><pre class="knitr r"><span class="hl com">## turning back on warnings</span>
<span class="hl kwd">options</span><span class="hl std">(</span><span class="hl kwc">warn</span><span class="hl std">=</span><span class="hl num">0</span><span class="hl std">)</span>
</pre></div>
</div></div>

<p>Now the final df is the percent error(mean absolute) of each of our forecasts. 

</body>
</html>
